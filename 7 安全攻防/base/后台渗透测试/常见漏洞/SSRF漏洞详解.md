# SSRF漏洞详解

服务器端请求伪造SSRF(Server-Side Request Forgery)漏洞，是由攻击者构造请求，由服务器端发起请求的安全漏洞。

## 流程

```sequence
participant 攻击者
participant 服务器A
participant 服务器B

攻击者-->>服务器B:请求不可直达
攻击者->服务器A:发送欺骗数据
服务器A->服务器B:执行欺骗数据，向B发起请求
服务器B-->服务器A:响应A的请求
服务器A-->攻击者:返回主机B响应A的请求
```

原理：很多web应用都提供了从其他的服务器上获取数据的功能。使用用户指定的URL，web应用可以获取图片、下载文件、读取文件内容等。这个功能如果被恶意使用，可利用存在缺陷的web应用作为代理攻击远程和本地的服务器，黑客可以利用SSRF漏洞获取内部系统的一些信息。SSRF的原因是因服务端提供了从其他服务器应用获取数据的功能且没有对目标地址做过滤与限制 。如从指定URL地址获取网页文本内容、加载指定地址的图片、下载等。

一般SSRF的攻击常用于以下用途：

+ 利用file协议读取本地文件
+ 对内网web应用进行指纹识别，识别企业内部的资产信息
+ 对服务器所在内网、本地进行端口扫描，获取一些服务的banner信息
+ 攻击运行在内网或本地的应用程序

## 对抗

SSRF的漏洞防御有如下方法：

+ 屏蔽返回的详细信息
+ 限制不能访问内网的ip，以防止对内网进行攻击
+ 限制请求的端口只能为web端口，只允许访问http和https的请求(禁掉file协议)

而攻击一般测试目标网站支持的伪协议：file、sftp、tftp、dict、ldap、gopher

## 挖掘

+ 分享功能：在早期分享应用中，为了更好的提供用户体验，WEB应用在分享功能中，通常会获取目标URL地址网页内容中的`<tilte></title>`标签或者`<meta name="description" content=""/>`标签中content的文本内容作为显示以提供更好的用户体验。如果在此功能中没有对目标地址的范围做过滤与限制则就存在着SSRF漏洞
+ 图片加载：加载远程图片地址此功能用到的地方很多，但大多是比较隐秘，比如在有些公司中的加载自家图片服务器上的图片用于展示。此处可能会有人有疑问，为什么加载图片服务器上的图片也会有问题，直接使用img标签不就好了？ 开发者为有更好的用户体验通常对图片做些微小调整例如加水印、压缩等，所以就可能造成SSRF问题
+ 文章或图片收藏功能：文章收藏就类似于分享功能中获取URL地址中title以及文本的内容作为显示，目的还是为了更好的用户体验；而图片收藏就类似于图片加载
+ 转码服务：由于手机屏幕大小的关系，直接浏览网页内容的时候会造成许多不便，因此有些公司提供了转码功能，把网页内容通过相关手段转为适合手机屏幕浏览的样式。例如百度、腾讯、搜狗等公司都有提供在线转码服务
+ 在线翻译：通过URL地址翻译对应文本的内容。提供此功能的国内公司有百度、有道等
+ 未公开的api实现以及其他调用URL的功能：此处类似的功能有360提供的网站评分，以及有些网站通过api获取远程地址xml文件来加载内容

如果在链接中看到了存在url类型的参数的话，就可以尝试是否存在SSRF漏洞，以下是常见的url中的关键字：u、url、wap、link、src、source、target、share、display、domain、sourceURl、imageURL。

